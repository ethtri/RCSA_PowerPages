<!-- Include Bootstrap 5 and Modern Enhancements -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet" />
<link rel="stylesheet" href="/bootstrap-5-upgrades.css" />
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="/modern-interactions.js"></script>

<style>
/* Dashboard Styles */
.dashboard-header {
  background: linear-gradient(135deg, #0d6efd 0%, #6610f2 100%);
  color: white;
  padding: 2rem 0;
  margin-bottom: 2rem;
  border-radius: 0.5rem;
}

.metric-card {
  background: white;
  border-radius: 0.5rem;
  padding: 1.5rem;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  border-left: 4px solid #0d6efd;
  transition: transform 0.2s ease;
}

.metric-card:hover {
  transform: translateY(-2px);
}

.metric-value {
  font-size: 2.5rem;
  font-weight: bold;
  color: #0d6efd;
  margin-bottom: 0.5rem;
}

.metric-label {
  color: #6c757d;
  font-size: 0.9rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.metric-subtitle {
  color: #6c757d;
  font-size: 0.8rem;
  margin-top: 0.25rem;
}

.assessment-card {
  background: white;
  border-radius: 0.5rem;
  padding: 1.25rem;
  margin-bottom: 1rem;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  border-left: 4px solid #28a745;
  transition: all 0.2s ease;
}

.assessment-card:hover {
  box-shadow: 0 4px 15px rgba(0,0,0,0.15);
}

.status-badge {
  font-size: 0.75rem;
  padding: 0.25rem 0.75rem;
  border-radius: 1rem;
  font-weight: 500;
}

.status-draft { background-color: #ffc107; color: #000; }
.status-submitted { background-color: #17a2b8; color: white; }
.status-agreed { background-color: #28a745; color: white; }
.status-challenged { background-color: #dc3545; color: white; }

.page-title {
  font-size: 2.5rem;
  font-weight: 300;
  margin-bottom: 0.5rem;
}

.page-subtitle {
  font-size: 1.1rem;
  opacity: 0.9;
}

.section-title {
  font-size: 1.5rem;
  font-weight: 600;
  margin-bottom: 1.5rem;
  color: #2c3e50;
}

.empty-state {
  text-align: center;
  padding: 3rem;
  color: #6c757d;
}

.empty-state i {
  font-size: 3rem;
  margin-bottom: 1rem;
  opacity: 0.5;
}
</style>

<div class="container-fluid">
  <!-- Header -->
  <div class="dashboard-header text-center">
    <h1 class="page-title">Risk Assessment Dashboard</h1>
    <p class="page-subtitle">Monitor your risk assessment portfolio and track progress</p>
  </div>

  <!-- Metrics Row -->
  <div class="row mb-4">
    <div class="col-md-3 mb-3">
      <div class="metric-card">
        <div class="metric-value">
          {% assign total_assessments = 0 %}
          {% fetchxml assessments_count %}
          <fetch version="1.0" output-format="xml-platform" mapping="logical" distinct="false">
            <entity name="cr129_assess">
              <attribute name="cr129_assessid" />
              <filter type="and">
                <condition attribute="statecode" operator="eq" value="0" />
              </filter>
            </entity>
          </fetch>
          {% endfetchxml %}
          {% for assessment in assessments_count.results.entities %}
            {% assign total_assessments = total_assessments | plus: 1 %}
          {% endfor %}
          {{ total_assessments }}
        </div>
        <div class="metric-label">Total Assessments</div>
        <div class="metric-subtitle">Your portfolio</div>
      </div>
    </div>

    <div class="col-md-3 mb-3">
      <div class="metric-card">
        <div class="metric-value">
          {% assign completed_assessments = 0 %}
          {% fetchxml completed_count %}
          <fetch version="1.0" output-format="xml-platform" mapping="logical" distinct="false">
            <entity name="cr129_assess">
              <attribute name="cr129_assessid" />
              <filter type="and">
                <condition attribute="statecode" operator="eq" value="0" />
                <condition attribute="cr129_assessmentstatus" operator="eq" value="0" />
              </filter>
            </entity>
          </fetch>
          {% endfetchxml %}
          {% for assessment in completed_count.results.entities %}
            {% assign completed_assessments = completed_assessments | plus: 1 %}
          {% endfor %}
          {{ completed_assessments }}
        </div>
        <div class="metric-label">Completed</div>
        <div class="metric-subtitle">
          {% if total_assessments > 0 %}
            {% assign completion_rate = completed_assessments | times: 100 | divided_by: total_assessments %}
            {{ completion_rate }}% completion rate
          {% else %}
            0% completion rate
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-md-3 mb-3">
      <div class="metric-card">
        <div class="metric-value">
          {% assign in_progress_assessments = 0 %}
          {% fetchxml in_progress_count %}
          <fetch version="1.0" output-format="xml-platform" mapping="logical" distinct="false">
            <entity name="cr129_assess">
              <attribute name="cr129_assessid" />
              <filter type="and">
                <condition attribute="statecode" operator="eq" value="0" />
                <filter type="or">
                  <condition attribute="cr129_assessmentstatus" operator="eq" value="2" />
                  <condition attribute="cr129_assessmentstatus" operator="eq" value="1" />
                </filter>
              </filter>
            </entity>
          </fetch>
          {% endfetchxml %}
          {% for assessment in in_progress_count.results.entities %}
            {% assign in_progress_assessments = in_progress_assessments | plus: 1 %}
          {% endfor %}
          {{ in_progress_assessments }}
        </div>
        <div class="metric-label">In Progress</div>
        <div class="metric-subtitle">Draft & Submitted</div>
      </div>
    </div>

    <div class="col-md-3 mb-3">
      <div class="metric-card">
        <div class="metric-value">
          {% assign challenged_assessments = 0 %}
          {% fetchxml challenged_count %}
          <fetch version="1.0" output-format="xml-platform" mapping="logical" distinct="false">
            <entity name="cr129_assess">
              <attribute name="cr129_assessid" />
              <filter type="and">
                <condition attribute="statecode" operator="eq" value="0" />
                <condition attribute="cr129_assessmentstatus" operator="eq" value="3" />
              </filter>
            </entity>
          </fetch>
          {% endfetchxml %}
          {% for assessment in challenged_count.results.entities %}
            {% assign challenged_assessments = challenged_assessments | plus: 1 %}
          {% endfor %}
          {{ challenged_assessments }}
        </div>
        <div class="metric-label">Challenged</div>
        <div class="metric-subtitle">Require attention</div>
      </div>
    </div>
  </div>

  <!-- Recent Assessments -->
  <div class="row">
    <div class="col-12">
      <h2 class="section-title">
        <i class="bi bi-clock-history me-2"></i>Recent Assessments
      </h2>
      
      {% fetchxml recent_assessments %}
      <fetch version="1.0" output-format="xml-platform" mapping="logical" distinct="false" top="10">
        <entity name="cr129_assess">
          <attribute name="cr129_assessid" />
          <attribute name="cr129_assessmentname" />
          <attribute name="cr129_assessmentdate" />
          <attribute name="cr129_assessmentstatus" />
          <attribute name="createdon" />
          <order attribute="createdon" descending="true" />
          <filter type="and">
            <condition attribute="statecode" operator="eq" value="0" />
          </filter>
        </entity>
      </fetch>
      {% endfetchxml %}

      {% if recent_assessments.results.entities.size > 0 %}
        {% for assessment in recent_assessments.results.entities %}
          <div class="assessment-card">
            <div class="row align-items-center">
              <div class="col-md-6">
                <h5 class="mb-1">
                  {% if assessment.cr129_assessmentname %}
                    {{ assessment.cr129_assessmentname }}
                  {% else %}
                    Assessment {{ assessment.cr129_assessid }}
                  {% endif %}
                </h5>
                <small class="text-muted">
                  <i class="bi bi-calendar me-1"></i>
                  {% if assessment.cr129_assessmentdate %}
                    {{ assessment.cr129_assessmentdate | date: "%B %d, %Y" }}
                  {% else %}
                    {{ assessment.createdon | date: "%B %d, %Y" }}
                  {% endif %}
                </small>
              </div>
              <div class="col-md-3">
                {% assign status_value = assessment.cr129_assessmentstatus %}
                {% if status_value == 0 %}
                  <span class="status-badge status-agreed">Agreed</span>
                {% elsif status_value == 1 %}
                  <span class="status-badge status-submitted">Submitted</span>
                {% elsif status_value == 2 %}
                  <span class="status-badge status-draft">Draft</span>
                {% elsif status_value == 3 %}
                  <span class="status-badge status-challenged">Challenged</span>
                {% else %}
                  <span class="status-badge status-draft">Unknown</span>
                {% endif %}
              </div>
              <div class="col-md-3 text-end">
                <a href="/risk-identification/?assessment={{ assessment.cr129_assessid }}" class="btn btn-outline-primary btn-sm">
                  <i class="bi bi-eye me-1"></i>View
                </a>
              </div>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="empty-state">
          <i class="bi bi-inbox"></i>
          <h4>No Assessments Yet</h4>
          <p>Start by creating your first risk assessment from the Process Selection page.</p>
          <a href="/process-selection/" class="btn btn-primary">
            <i class="bi bi-plus-circle me-1"></i>Start Assessment
          </a>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="row mt-4">
    <div class="col-12">
      <h2 class="section-title">
        <i class="bi bi-lightning me-2"></i>Quick Actions
      </h2>
      <div class="row">
        <div class="col-md-4 mb-3">
          <div class="card h-100">
            <div class="card-body text-center">
              <i class="bi bi-plus-circle text-primary" style="font-size: 2rem;"></i>
              <h5 class="card-title mt-2">New Assessment</h5>
              <p class="card-text">Start a new risk assessment for your process.</p>
              <a href="/process-selection/" class="btn btn-primary">Get Started</a>
            </div>
          </div>
        </div>
        <div class="col-md-4 mb-3">
          <div class="card h-100">
            <div class="card-body text-center">
              <i class="bi bi-search text-info" style="font-size: 2rem;"></i>
              <h5 class="card-title mt-2">Risk Identification</h5>
              <p class="card-text">Identify and analyze potential risks.</p>
              <a href="/risk-identification/" class="btn btn-info">Identify Risks</a>
            </div>
          </div>
        </div>
        <div class="col-md-4 mb-3">
          <div class="card h-100">
            <div class="card-body text-center">
              <i class="bi bi-shield-check text-success" style="font-size: 2rem;"></i>
              <h5 class="card-title mt-2">Control Mapping</h5>
              <p class="card-text">Map controls to identified risks.</p>
              <a href="/control-mapping/" class="btn btn-success">Map Controls</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Add some interactive enhancements
document.addEventListener('DOMContentLoaded', function() {
  // Add hover effects to metric cards
  const metricCards = document.querySelectorAll('.metric-card');
  metricCards.forEach(card => {
    card.addEventListener('mouseenter', function() {
      this.style.transform = 'translateY(-3px)';
    });
    
    card.addEventListener('mouseleave', function() {
      this.style.transform = 'translateY(0)';
    });
  });
  
  // Add click tracking for analytics
  const actionButtons = document.querySelectorAll('.btn');
  actionButtons.forEach(button => {
    button.addEventListener('click', function() {
      console.log('Dashboard action clicked:', this.textContent.trim());
    });
  });
});
</script>
