
<!-- Handle Unlink Form Submission -->
{% if request.params.action == 'unlink_risk' %}
  {% assign risk_id = request.params.risk_id %}
  {% assign risk_title = request.params.risk_title %}
  
  <script>
    // Show processing message immediately
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Processing unlink for risk: {{ risk_id }}');
      // The page will reload with the risk removed from the filter
      if (typeof modernInteractions !== 'undefined') {
        modernInteractions.showSuccess('Risk Unlinked', '{{ risk_title }} has been unlinked from the process');
      }
    });
  </script>
  
  <!-- Trigger Power Automate Flow via hidden form submission -->
  <form id="unlinkFlowForm" method="POST" action="YOUR_FLOW_TRIGGER_URL_HERE" style="display: none;">
    <input type="hidden" name="risk_id" value="{{ risk_id }}">
    <input type="hidden" name="risk_title" value="{{ risk_title }}">
  </form>
  
  <script>
    // Auto-submit to Power Automate (optional - configure your flow trigger URL)
    // document.getElementById('unlinkFlowForm').submit();
  </script>
{% endif %}

<!-- Include Bootstrap 5 and Modern Enhancements -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- DATAVERSE INTEGRATION: FetchXML for Existing Risks -->
<!-- SIMPLIFIED: Basic fields only to avoid Liquid errors -->
{% fetchxml existingRisks %}
  <fetch version="1.0" output-format="xml-platform" mapping="logical" distinct="false">
    <entity name="cr129_risk">
      <attribute name="cr129_riskid" />
      <attribute name="cr129_risktitle" />
      <attribute name="cr129_riskcategory" />
      <attribute name="cr129_processname" />
      <attribute name="cr129_description" />
      <attribute name="cr129_inherentlikelihood" />
      <attribute name="cr129_inherentimpact" />
      <attribute name="modifiedon" />
      <filter type="and">
        <condition attribute="statecode" operator="eq" value="0" />
      </filter>
      <order attribute="cr129_risktitle" descending="false" />
    </entity>
  </fetch>
{% endfetchxml %}

<!-- ANTI-FORGERY TOKEN: Hidden form for Web API authentication -->
<!-- Note: Power Pages generates anti-forgery tokens automatically in forms -->

<!-- Debug info removed for cleaner UI -->

<style>
/* ========================================
   RISK IDENTIFICATION ENHANCED STYLES v2.1
   ========================================
   
   IMPORTANT: This CSS includes enhanced card separation
   and visual improvements. Do not remove or modify the
   following styles without updating the version number:
   
   - .risk-card enhanced shadows and spacing
   - .risk-card:not(:last-child)::after separators
   - Enhanced hover effects and color-coded borders
   
   Last updated: Enhanced card separation implementation
   ======================================== */

.risk-card {
  background: white !important;
  border: 1px solid #e9ecef !important;
  border-radius: 12px;
  padding: 1.5rem;
  padding-top: 3.5rem;
  margin-bottom: 1.5rem !important;
  transition: all 0.3s ease;
  position: relative;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important;
}

/* Enhanced Risk Identification Styles */
.risk-header {
  background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
  color: white;
  padding: 3rem 0;
  margin-bottom: 2rem;
}

/* List Component Styling */
.list-container {
  background: white;
  border-radius: 8px;
  overflow: hidden;
}

.list-container .table {
  margin-bottom: 0;
}

.list-container .table th {
  background: #f8f9fa;
  border-bottom: 2px solid #dee2e6;
  font-weight: 600;
  color: #495057;
}

.list-container .table td {
  vertical-align: middle;
  padding: 1rem 0.75rem;
}

.list-container .btn-outline-primary {
  border-color: #0d6efd;
  color: #0d6efd;
}

.list-container .btn-outline-primary:hover {
  background-color: #0d6efd;
  border-color: #0d6efd;
  color: white;
}

/* Empty state styling for list */
.list-container .alert-info {
  border: none;
  background: #f8f9fa;
  color: #6c757d;
  text-align: center;
  padding: 2rem;
  margin: 0;
}

/* Pagination styling */
.list-container .pagination {
  justify-content: center;
  margin-top: 1rem;
}

.list-container .page-link {
  color: #0d6efd;
  border-color: #dee2e6;
}

.list-container .page-item.active .page-link {
  background-color: #0d6efd;
  border-color: #0d6efd;
}

.ai-badge {
  background: rgba(255, 255, 255, 0.2);
  padding: 0.5rem 1rem;
  border-radius: 20px;
  font-size: 0.875rem;
  display: inline-block;
  margin-bottom: 1rem;
}

.section-card {
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.1);
  margin-bottom: 2rem;
  overflow: hidden;
}

.section-header {
  padding: 1.5rem 2rem;
  border-bottom: 1px solid #e9ecef;
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 1.5rem;
}

.section-header.existing {
  background: linear-gradient(45deg, #0d6efd, #6610f2);
  color: white;
  border-bottom: none;
}

.section-header.ai {
  background: linear-gradient(45deg, #28a745, #20c997);
  color: white;
  border-bottom: none;
}

.section-header.custom {
  background: linear-gradient(45deg, #ffc107, #fd7e14);
  color: white;
  border-bottom: none;
}

.section-header .badge {
  flex-shrink: 0;
  margin-top: 0.25rem;
  font-size: 0.875rem !important;
  padding: 0.5rem 1rem;
}

.section-body {
  padding: 2rem;
}

.risk-card {
  background: white !important;
  border: 1px solid #e9ecef !important;
  border-radius: 12px;
  padding: 1.5rem;
  padding-top: 3.5rem;
  margin-bottom: 1.5rem !important;
  transition: all 0.3s ease;
  position: relative;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08) !important;
}

.risk-card:hover {
  transform: translateY(-3px) !important;
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15) !important;
  border-color: #dee2e6 !important;
}

.risk-card.existing {
  border-left: 4px solid #0d6efd !important;
  background: white !important;
  box-shadow: 0 2px 8px rgba(13, 110, 253, 0.1) !important;
}

.risk-card.existing:hover {
  box-shadow: 0 6px 20px rgba(13, 110, 253, 0.2) !important;
}

.risk-card.ai-suggested {
  border-left: 4px solid #28a745 !important;
  background: white !important;
  box-shadow: 0 2px 8px rgba(40, 167, 69, 0.1) !important;
}

.risk-card.ai-suggested:hover {
  box-shadow: 0 6px 20px rgba(40, 167, 69, 0.2) !important;
}

.risk-card.accepted {
  border: 2px solid #28a745 !important;
  background: #f8fff9 !important;
  box-shadow: 0 4px 12px rgba(40, 167, 69, 0.15) !important;
}

.risk-card.rejected {
  border: 2px solid #dc3545 !important;
  background: #fff5f5 !important;
  opacity: 0.7;
  box-shadow: 0 2px 8px rgba(220, 53, 69, 0.1) !important;
}

/* Add subtle separator between cards - Enhanced */
.risk-card:not(:last-child)::after {
  content: '' !important;
  position: absolute !important;
  bottom: -0.75rem !important;
  left: 50% !important;
  transform: translateX(-50%) !important;
  width: 60% !important;
  height: 1px !important;
  background: linear-gradient(90deg, transparent, #e9ecef, transparent) !important;
  opacity: 0.5 !important;
  z-index: 1 !important;
}

/* === ENHANCED CARD VISUAL SEPARATION - SIMPLIFIED === */
/* Basic visual improvements without complex selectors */

/* Enhanced Card Visual Separation - Maximum Specificity */
.container .section-card .section-body .risk-card.existing {
  box-shadow: 0 8px 25px rgba(25, 118, 210, 0.12) !important;
  border: 1px solid rgba(25, 118, 210, 0.1) !important;
  background: #ffffff !important;
  margin-bottom: 1.5rem !important;
  border-radius: 12px !important;
}

.container .section-card .section-body .risk-card.ai-suggested {
  box-shadow: 0 8px 25px rgba(76, 175, 80, 0.12) !important;
  border: 1px solid rgba(76, 175, 80, 0.1) !important;
  background: #ffffff !important;
  margin-bottom: 1.5rem !important;
  border-radius: 12px !important;
}

.container .section-card .section-body .risk-card.custom {
  box-shadow: 0 8px 25px rgba(245, 124, 0, 0.12) !important;
  border: 1px solid rgba(245, 124, 0, 0.1) !important;
  background: #ffffff !important;
  margin-bottom: 1.5rem !important;
  border-radius: 12px !important;
}

/* Basic card spacing */
.risk-card {
  margin-bottom: 1.5rem !important;
}

/* === END ENHANCED CARD SEPARATION === */

/* Enhanced Risk Card Components */
.risk-card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 1rem;
  gap: 1rem;
}

.risk-card-title {
  font-size: 1.1rem;
  font-weight: 600;
  color: #2c3e50;
  margin: 0;
  line-height: 1.3;
}

.risk-card-description {
  color: #6c757d;
  margin-bottom: 1rem;
  line-height: 1.5;
  font-size: 0.95rem;
}

.risk-metrics {
  background: #f8f9fa;
  border-radius: 8px;
  padding: 1rem;
  margin-bottom: 1rem;
}

.risk-metrics-header {
  font-size: 0.875rem;
  font-weight: 600;
  color: #495057;
  margin-bottom: 0.75rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.risk-metrics-grid {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 1rem;
  align-items: center;
}

.risk-metric-item {
  text-align: center;
}

.risk-metric-label {
  font-size: 0.75rem;
  color: #6c757d;
  margin-bottom: 0.25rem;
  text-transform: uppercase;
  font-weight: 500;
}

.risk-metric-value {
  font-size: 1.25rem;
  font-weight: 700;
  color: #2c3e50;
}

.risk-score-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  font-size: 1rem;
  font-weight: 700;
  color: white;
  text-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

.risk-score-1, .risk-score-2 { background: linear-gradient(135deg, #28a745, #20c997); }
.risk-score-3, .risk-score-4, .risk-score-5, .risk-score-6 { background: linear-gradient(135deg, #ffc107, #fd7e14); }
.risk-score-7, .risk-score-8, .risk-score-9, .risk-score-10 { background: linear-gradient(135deg, #fd7e14, #dc3545); }
.risk-score-11, .risk-score-12, .risk-score-13, .risk-score-14, .risk-score-15 { background: linear-gradient(135deg, #dc3545, #6f42c1); }
.risk-score-16, .risk-score-17, .risk-score-18, .risk-score-19, .risk-score-20, .risk-score-21, .risk-score-22, .risk-score-23, .risk-score-24, .risk-score-25 { background: linear-gradient(135deg, #6f42c1, #495057); }

.risk-card-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 1rem;
  padding-top: 1rem;
  border-top: 1px solid #e9ecef;
}

.risk-card-metadata {
  font-size: 0.8rem;
  color: #6c757d;
}

.risk-card-actions {
  display: flex;
  gap: 0.5rem;
}

/* Category badges with better colors */
.risk-category-badge {
  font-size: 0.75rem;
  padding: 0.35rem 0.75rem;
  border-radius: 20px;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.risk-category-operational { background: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb; }
.risk-category-technology { background: #f3e5f5; color: #7b1fa2; border: 1px solid #ce93d8; }
.risk-category-fraud { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
.risk-category-compliance { background: #e8f5e8; color: #2e7d32; border: 1px solid #c8e6c9; }
.risk-category-credit { background: #fff3e0; color: #ef6c00; border: 1px solid #ffcc02; }

/* Risk source badge positioning - Simple fix */
.risk-source-badge {
  position: absolute !important;
  top: 0.75rem !important;
  right: 0.75rem !important;
  z-index: 10 !important;
}

.risk-source-badge.existing { 
  background: #e3f2fd; 
  color: #1976d2; 
  border: 1px solid #bbdefb;
}

.risk-source-badge.ai { 
  background: #e8f5e8; 
  color: #2e7d32; 
  border: 1px solid #c8e6c9;
}

.risk-source-badge.custom { 
  background: #fff8e1; 
  color: #f57c00; 
  border: 1px solid #ffecb3;
}

.risk-matrix {
  background: #f8f9fa;
  border-radius: 8px;
  padding: 1rem;
  margin: 1rem 0;
}

.matrix-cell {
  width: 30px;
  height: 30px;
  border-radius: 4px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 0.75rem;
  margin: 2px;
}

.matrix-cell.active {
  border: 2px solid #0d6efd;
  transform: scale(1.1);
}

.risk-level-1 { background: #d4edda; color: #155724; }
.risk-level-2 { background: #d1ecf1; color: #0c5460; }
.risk-level-3 { background: #fff3cd; color: #856404; }
.risk-level-4 { background: #f8d7da; color: #721c24; }
.risk-level-5 { background: #f5c6cb; color: #721c24; }

.summary-card {
  background: linear-gradient(45deg, #28a745, #20c997);
  color: white;
  border-radius: 12px;
  padding: 2rem;
  text-align: center;
  margin-bottom: 2rem;
  position: sticky;
  top: 2rem;
}

.summary-number {
  font-size: 3rem;
  font-weight: bold;
  line-height: 1;
}

.loading-placeholder {
  text-align: center;
  padding: 3rem;
  color: #6c757d;
}

.empty-state {
  text-align: center;
  padding: 3rem;
  color: #6c757d;
}

/* Ensure proper spacing for risk card content */
.risk-card .d-flex.justify-content-between.align-items-start {
  margin-top: 0.5rem;
}

@media (max-width: 768px) {
  .risk-header {
    padding: 2rem 0;
  }
  
  .section-body {
    padding: 1.5rem;
  }
  
  .section-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 1rem;
  }
  
  .section-header .badge {
    margin-top: 0;
  }
  
  .summary-card {
    position: relative;
    top: auto;
  }
  
  .risk-card {
    padding-top: 3rem;
  }
  
  .risk-source-badge {
    font-size: 0.7rem;
    padding: 0.25rem 0.5rem;
  }
}

/* ============================================================================ */
/* PROTECTED FIXES - DO NOT REMOVE OR MODIFY */
/* These fixes address recurring UX issues and are protected against overwrites */
/* ============================================================================ */

/* PROTECTED FIX #1: Overlapping Labels Solution */
.risk-source-badge {
  position: absolute !important;
  top: 0.5rem !important;
  right: 0.5rem !important;
  font-size: 0.7rem !important;
  padding: 0.3rem 0.6rem !important;
  border-radius: 12px !important;
  z-index: 15 !important;
  font-weight: 600 !important;
  text-transform: uppercase !important;
  letter-spacing: 0.3px !important;
  transform: translateY(0) !important;
  margin: 0 !important;
}

/* PROTECTED FIX #2: Remove AI Card Color Stripe */
.container .section-card .section-body .risk-card.ai {
  border-left: none !important;
  border-image: none !important;
  border-left-color: transparent !important;
  border-left-width: 0 !important;
}

/* Force removal of any left border or stripe on AI cards */
.risk-card.ai,
.risk-card.ai::before,
.risk-card.ai::after {
  border-left: none !important;
  border-image: none !important;
}

/* PROTECTED FIX #3: Category Badge Positioning - Prevent Overlap */
.risk-card .badge:not(.risk-source-badge) {
  margin-top: 2.5rem !important;
  position: relative !important;
  z-index: 5 !important;
  clear: both !important;
  display: inline-block !important;
}

/* Ensure proper spacing for all card content when source badge is present */
.risk-card {
  padding-top: 2rem !important;
}

.risk-card .card-body,
.risk-card > .d-flex:first-child {
  margin-top: 1rem !important;
}

/* === END PROTECTED FIXES === */

/* Risk card hover and visual effects - CONSISTENT CLASSES */
.risk-card.ai-suggested,
.risk-card.ai-suggested::before,
.risk-card.ai-suggested::after {
  transition: all 0.3s ease !important;
}

/* Ensure all risk cards have consistent spacing and shadows */
.risk-card.existing,
.risk-card.ai-suggested,
.risk-card.custom {
  background: white !important;
  border-radius: 12px !important;
  padding: 1.5rem !important;
  padding-top: 3.5rem !important;
  margin-bottom: 1.5rem !important;
  position: relative !important;
  transition: all 0.3s ease !important;
}

/* Entity Form Styling to Match Card UI */
.entity-form .form-group {
  margin-bottom: 1.5rem;
}

.entity-form .control-label {
  font-weight: 600;
  color: #495057;
  margin-bottom: 0.5rem;
}

.entity-form .form-control {
  border-radius: 8px;
  border: 1px solid #dee2e6;
  padding: 0.75rem;
  transition: all 0.2s ease;
}

.entity-form .form-control:focus {
  border-color: #0d6efd;
  box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.entity-form .btn-primary {
  background: linear-gradient(135deg, #0d6efd 0%, #6610f2 100%);
  border: none;
  border-radius: 8px;
  padding: 0.75rem 2rem;
  font-weight: 500;
  transition: all 0.3s ease;
}

.entity-form .btn-primary:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);
}

.entity-form .btn-secondary {
  border-radius: 8px;
  padding: 0.75rem 2rem;
  font-weight: 500;
}

/* Card-style container for the form */
.entity-form-container {
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.1);
  padding: 2rem;
  margin: 2rem auto;
  max-width: 800px;
}

.entity-form-header {
  border-bottom: 1px solid #e9ecef;
  padding-bottom: 1rem;
  margin-bottom: 2rem;
}

.entity-form-header h2 {
  color: #0d6efd;
  font-weight: 600;
  margin: 0;
}

/* Success message styling */
.alert-success {
  border-radius: 8px;
  border-left: 4px solid #28a745;
  background: #f8fff9;
}

/* Validation error styling */
.field-validation-error {
  color: #dc3545;
  font-size: 0.875rem;
  margin-top: 0.25rem;
}

.input-validation-error {
  border-color: #dc3545 !important;
  box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
}

/* Offcanvas Risk Edit Panel Styling */
#riskEditPanel {
  box-shadow: -10px 0 40px rgba(0,0,0,0.15);
}

#riskEditPanel .offcanvas-header {
  background: linear-gradient(135deg, #0d6efd 0%, #6610f2 100%);
  padding: 1.5rem;
}

#riskEditPanel .offcanvas-title {
  font-weight: 600;
  font-size: 1.25rem;
}

#riskEditPanel .offcanvas-body {
  padding: 2rem;
  background-color: #f8f9fa;
}

/* Style the entity form in offcanvas */
#riskEditPanel .entity-form {
  background: white;
  padding: 1.5rem;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

#riskEditPanel .form-control, 
#riskEditPanel .form-select {
  border-radius: 8px;
  border: 1px solid #dee2e6;
  padding: 0.75rem;
  margin-bottom: 1rem;
}

#riskEditPanel .form-control:focus, 
#riskEditPanel .form-select:focus {
  border-color: #0d6efd;
  box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

#riskEditPanel .btn-primary {
  background: linear-gradient(135deg, #0d6efd, #6610f2);
  border: none;
  border-radius: 8px;
  padding: 0.75rem 2rem;
  font-weight: 500;
}

#riskEditPanel .btn-primary:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);
}

#riskEditPanel .form-label {
  font-weight: 500;
  color: #495057;
  margin-bottom: 0.5rem;
}

/* Status field styling */
#riskEditPanel select[name*="riskstatus"] {
  font-weight: 500;
}

#riskEditPanel input[type="checkbox"][name*="isactive"] {
  width: 1.5rem;
  height: 1.5rem;
  cursor: pointer;
}

/* Unlink Toggle Styling */
.form-check-input.unlink-toggle {
  cursor: pointer;
  width: 3rem;
  height: 1.5rem;
}

.form-check-input.unlink-toggle:checked {
  background-color: #ffc107;
  border-color: #ffc107;
}

.form-check-label {
  cursor: pointer;
  user-select: none;
  font-size: 0.875rem;
  font-weight: 500;
}

/* Floating Action Button Styling */
#batchUnlinkContainer .card {
  border: none;
  border-radius: 12px;
}

#batchUnlinkContainer .btn-warning {
  background: linear-gradient(135deg, #ffc107, #fd7e14);
  border: none;
  font-weight: 600;
}

#batchUnlinkContainer .btn-warning:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(255, 193, 7, 0.3);
}
</style>

<!-- Enhanced Bootstrap 5 Risk Identification Page -->
<div class="container-fluid">
  
  <!-- Page Header -->
  <div class="risk-header">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-8">
          <div class="ai-badge">
            <i class="bi bi-robot me-2"></i>
            Enhanced Risk Discovery
          </div>
          <h1 class="display-5 fw-bold mb-2">Risk Identification</h1>
          <p class="lead mb-0">Comprehensive risk discovery: existing, AI-suggested, and custom risks</p>
        </div>
        <div class="col-md-4 text-md-end">
          <div class="step-indicator bg-white bg-opacity-25 rounded-pill px-3 py-1">
            <i class="bi bi-2-circle me-2"></i>
            Step 2 of 5
          </div>
          <div class="h5 mt-2 mb-0">Risk Discovery</div>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="row">
      
      <!-- Main Content -->
      <div class="col-lg-8">
        
        <!-- Debug buttons removed for cleaner UI -->
        
        <!-- Section 1: Existing Risks -->
        <div class="section-card">
          <div class="section-header existing">
            <div>
              <h3 class="h4 mb-1">
                <i class="bi bi-database me-2"></i>
                Existing Risks
              </h3>
              <p class="mb-0 opacity-75">Risks already identified for this process</p>
            </div>
            <div class="d-flex align-items-center gap-2">
            <div class="badge bg-white text-primary fs-6" id="existingRiskCount">
              Loading...
              </div>
            </div>
          </div>
          <div class="section-body">
            
            <!-- Card View (Beautiful Cards with Navigation-Based Edit) -->
            <div id="cardViewContainer">
              <!-- Custom Risk Cards Implementation -->
            <div id="existingRisksContainer">
                <!-- All risks loaded - will be filtered by JavaScript -->
                <div id="allRisksData" style="display: none;">
                  {% for risk in existingRisks.results.entities %}
                    <div class="risk-data" 
                         data-risk-id="{{ risk.cr129_riskid }}"
                         data-risk-title="{{ risk.cr129_risktitle | escape }}"
                         data-risk-category="{{ risk.cr129_riskcategory.label | default: 'Not categorized' | escape }}"
                         data-risk-category-value="{{ risk.cr129_riskcategory.value | default: '' }}"
                         data-risk-description="{{ risk.cr129_description | default: 'No description available' | escape }}"
                         data-risk-likelihood="{{ risk.cr129_inherentlikelihood | default: '' }}"
                         data-risk-impact="{{ risk.cr129_inherentimpact | default: '' }}"
                         data-risk-modified="{{ risk.modifiedon | date: '%Y-%m-%d' | default: '' }}"
                         data-process-id="{{ risk.cr129_processname.id | default: '' }}"
                         data-process-name="{{ risk.cr129_processname.name | default: 'Unknown Process' | escape }}">
                      </div>
                    {% endfor %}
                </div>
                
                <!-- Filtered risks will be displayed here by JavaScript -->
                <div id="filteredRisksContainer">
              <div class="loading-placeholder">
                <div class="spinner-border text-primary mb-3" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                    <p>Loading and filtering risks for selected process...</p>
              </div>
            </div>
              </div>
            </div>
            
            <!-- List View removed for cleaner UI -->
            
          </div>
        </div>

        <!-- Section 2: AI-Suggested Risks -->
        <div class="section-card">
          <div class="section-header ai">
            <div>
              <h3 class="h4 mb-1">
                <i class="bi bi-lightbulb me-2"></i>
                AI-Suggested Risks
              </h3>
              <p class="mb-0 opacity-75">AI-powered risk suggestions based on industry best practices</p>
            </div>
            <div class="badge bg-white text-success fs-6" id="aiRiskCount">
              3 Suggested
            </div>
          </div>
          <div class="section-body">
            <div id="aiRisksContainer">
              <div class="loading-placeholder">
                <div class="spinner-border text-success mb-3" role="status">
                  <span class="visually-hidden">Generating...</span>
                </div>
                <p>AI is analyzing your process and generating risk suggestions...</p>
                <small class="text-muted">This typically takes 2-3 seconds</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Section 3: Custom Risk Entry -->
        <div class="section-card">
          <div class="section-header custom">
            <div>
              <h3 class="h4 mb-1">
                <i class="bi bi-plus-circle me-2"></i>
                Add Custom Risk
              </h3>
              <p class="mb-0 opacity-75">Create custom risks specific to your situation</p>
            </div>
            <button class="btn btn-light btn-sm" onclick="toggleCustomRiskForm()">
              <i class="bi bi-plus me-1"></i>Add Risk
            </button>
          </div>
          <div class="section-body">
            <div id="customRiskForm" style="display: none;">
              <form id="addCustomRiskForm">
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="customRiskTitle" class="form-label">Risk Title</label>
                      <input type="text" class="form-control" id="customRiskTitle" required>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="customRiskCategory" class="form-label">Category</label>
                      <select class="form-select" id="customRiskCategory" required>
                        <option value="">Select Category...</option>
                        <option value="Operational">Operational</option>
                        <option value="Technology">Technology</option>
                        <option value="Fraud">Fraud</option>
                        <option value="Compliance">Compliance</option>
                        <option value="Credit">Credit</option>
                      </select>
                    </div>
                  </div>
                </div>
                <div class="mb-3">
                  <label for="customRiskDescription" class="form-label">Description</label>
                  <textarea class="form-control" id="customRiskDescription" rows="3" required></textarea>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="customRiskLikelihood" class="form-label">Likelihood (1-5)</label>
                      <select class="form-select" id="customRiskLikelihood" required>
                        <option value="">Select...</option>
                        <option value="1">1 - Very Low</option>
                        <option value="2">2 - Low</option>
                        <option value="3">3 - Medium</option>
                        <option value="4">4 - High</option>
                        <option value="5">5 - Very High</option>
                      </select>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="customRiskImpact" class="form-label">Impact (1-5)</label>
                      <select class="form-select" id="customRiskImpact" required>
                        <option value="">Select...</option>
                        <option value="1">1 - Negligible</option>
                        <option value="2">2 - Minor</option>
                        <option value="3">3 - Moderate</option>
                        <option value="4">4 - Major</option>
                        <option value="5">5 - Severe</option>
                      </select>
                    </div>
                  </div>
                </div>
                <div class="d-flex gap-2">
                  <button type="submit" class="btn btn-warning">
                    <i class="bi bi-plus me-1"></i>Add Custom Risk
                  </button>
                  <button type="button" class="btn btn-outline-secondary" onclick="toggleCustomRiskForm()">
                    Cancel
                  </button>
                </div>
              </form>
            </div>
            <!-- Custom Risks Display -->
            <div id="customRisksDisplay" style="display: none;">
              <!-- Custom risks will be displayed here -->
            </div>
            
            <!-- Empty State - PROTECTED FIX #3: Hide when custom risks exist -->
            <div id="customRisksEmpty" class="empty-state">
              <i class="bi bi-plus-circle-dotted text-muted mb-3" style="font-size: 3rem;"></i>
              <h5 class="text-muted">No Custom Risks Added</h5>
              <p class="text-muted">Click 'Add Risk' to create a custom risk specific to your situation</p>
            </div>
          </div>
        </div>

      </div>

      <!-- Sidebar -->
      <div class="col-lg-4">
        
        <!-- Risk Summary -->
        <div class="summary-card">
          <div class="summary-number" id="totalRiskCount">0</div>
          <div class="h5 mb-3">Total Risks Identified</div>
          <div class="row text-center">
            <div class="col-4">
              <div class="h6" id="existingCount">0</div>
              <small>Existing</small>
            </div>
            <div class="col-4">
              <div class="h6" id="aiCount">0</div>
              <small>AI Added</small>
            </div>
            <div class="col-4">
              <div class="h6" id="customCount">0</div>
              <small>Custom</small>
            </div>
          </div>
        </div>

        <!-- Process Context -->
        <div class="section-card">
          <div class="section-body">
            <h5 class="fw-bold mb-3">
              <i class="bi bi-gear me-2 text-primary"></i>
              Selected Process
            </h5>
            <div class="d-flex align-items-center mb-3">
              <div class="flex-grow-1">
                <div class="fw-semibold" id="selectedProcessName">Loading...</div>
                <small class="text-muted" id="selectedBusinessUnit">Loading...</small>
              </div>
            </div>
            <hr>
            <h6 class="fw-bold mb-2">Next Steps</h6>
            <ul class="list-unstyled small text-muted">
              <li class="mb-1">✓ Review existing risks</li>
              <li class="mb-1">✓ Accept relevant AI suggestions</li>
              <li class="mb-1">✓ Add custom risks if needed</li>
              <li class="mb-1">→ Continue to control mapping</li>
            </ul>
          </div>
        </div>

      </div>
    </div>

    <!-- Action Buttons -->
    <div class="row mt-4 mb-4">
      <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
          <button class="btn btn-outline-secondary btn-lg" onclick="goBack()">
            <i class="bi bi-arrow-left me-2"></i>
            Back to Process Selection
          </button>
          <button class="btn btn-success btn-lg" id="continueBtn" onclick="continueToNextStep()" disabled>
            Continue to Control Mapping
            <i class="bi bi-arrow-right ms-2"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Test sections removed for cleaner UI -->

<!-- Enhanced JavaScript -->
<script>
class EnhancedRiskIdentification {
  constructor() {
    this.existingRisks = [];
    this.aiSuggestedRisks = [];
    this.customRisks = [];
    this.acceptedAiRisks = [];
    this.selectedProcess = null;
    this.selectedProcessId = null;
    this.selectedBusinessUnit = null;
    this.selectedBusinessUnitId = null;
    this.init();
  }

  init() {
    this.loadSessionData();
    this.bindEvents();
    this.loadExistingRisks();
    this.generateAISuggestions();
    this.updateUI();
    console.log('✅ Enhanced Risk Identification initialized');
  }

  loadSessionData() {
    // Get process selection from previous step - CORRECTED KEYS
    this.selectedProcessId = sessionStorage.getItem('rcsa_selected_process_id');
    this.selectedProcess = sessionStorage.getItem('rcsa_selected_process_name');
    this.selectedBusinessUnit = sessionStorage.getItem('rcsa_selected_business_unit');
    this.selectedBusinessUnitId = sessionStorage.getItem('rcsa_selected_business_unit_id');
    
    console.log('📋 Session data loaded:', {
      processId: this.selectedProcessId,
      processName: this.selectedProcess,
      businessUnit: this.selectedBusinessUnit,
      businessUnitId: this.selectedBusinessUnitId
    });
    
    // Update UI with process info
    this.updateProcessInfo();
  }

  updateProcessInfo() {
    const processNameEl = document.getElementById('selectedProcessName');
    const businessUnitEl = document.getElementById('selectedBusinessUnit');
    
    if (processNameEl) {
      processNameEl.textContent = this.selectedProcess || 'Selected Process';
    }
    
    if (businessUnitEl) {
      businessUnitEl.textContent = this.selectedBusinessUnit || 'Selected Business Unit';
    }
  }

  bindEvents() {
    // Custom risk form
    document.getElementById('addCustomRiskForm').addEventListener('submit', (e) => {
      e.preventDefault();
      this.addCustomRisk();
    });

    // Continue button
    document.getElementById('continueBtn').addEventListener('click', () => {
      this.continueToNextStep();
    });
  }

  async loadExistingRisks() {
    try {
      // DATAVERSE INTEGRATION: Parse existing risks from Liquid template
      this.parseExistingRisksFromPage();
    } catch (error) {
      console.error('❌ Failed to load existing risks:', error);
      this.showExistingRisksError();
    }
  }

  parseExistingRisksFromPage() {
    console.log('🔍 Parsing existing risks from page...');
    
    const riskDataElements = document.querySelectorAll('#allRisksData .risk-data');
    const risks = [];
    
    riskDataElements.forEach(element => {
      const riskData = {
        id: element.dataset.riskId,
        title: element.dataset.riskTitle,
        category: element.dataset.riskCategory,
        categoryValue: element.dataset.riskCategoryValue,
        description: element.dataset.riskDescription || 'No description available',
        likelihood: parseInt(element.dataset.riskLikelihood) || null,
        impact: parseInt(element.dataset.riskImpact) || null,
        modifiedDate: element.dataset.riskModified,
        processId: element.dataset.processId,
        processName: element.dataset.processName,
        source: 'existing'
      };
      
      // Calculate risk score if likelihood and impact are available
      if (riskData.likelihood && riskData.impact) {
        riskData.riskScore = riskData.likelihood * riskData.impact;
      }
      
      console.log('📋 Found risk:', riskData);
      risks.push(riskData);
    });
    
    // Filter risks by selected process
    const filteredRisks = risks.filter(risk => {
      const matches = risk.processId === this.selectedProcessId;
      console.log(`🔍 Risk "${risk.title}" process "${risk.processId}" matches selected "${this.selectedProcessId}": ${matches}`);
      return matches;
    });
    
    console.log(`📊 Total risks found: ${risks.length}, Filtered for process: ${filteredRisks.length}`);
    
    this.existingRisks = filteredRisks;
    this.updateExistingRisksDisplay();
  }

  updateExistingRisksDisplay() {
    const container = document.getElementById('filteredRisksContainer');
    
    if (this.existingRisks.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <i class="bi bi-info-circle-fill text-muted mb-3" style="font-size: 3rem;"></i>
          <h4 class="text-muted">No Existing Risks Found</h4>
          <p class="text-muted">No risks have been identified for this process yet. Use the sections below to add risks.</p>
        </div>
      `;
      return;
    }

    container.innerHTML = this.existingRisks.map(risk => {
      const categoryClass = this.getCategoryClass(risk.category);
      const riskScore = risk.riskScore || 0;
      const likelihoodText = this.getLikelihoodText(risk.likelihood);
      const impactText = this.getImpactText(risk.impact);
      
      return `
      <div class="risk-card existing" data-risk-id="${risk.id}">
        <div class="risk-card-header">
          <h5 class="risk-card-title">${risk.title}</h5>
          <span class="risk-category-badge ${categoryClass}">${risk.category}</span>
        </div>
        
        <div class="risk-card-description">
          ${risk.description || 'No description available'}
        </div>
        
        ${risk.likelihood && risk.impact ? `
        <div class="risk-metrics">
          <div class="risk-metrics-header">
            <i class="bi bi-graph-up"></i>
            Risk Assessment
          </div>
          <div class="risk-metrics-grid">
            <div class="risk-metric-item">
              <div class="risk-metric-label">Likelihood</div>
              <div class="risk-metric-value">${risk.likelihood}</div>
              <div class="small text-muted">${likelihoodText}</div>
            </div>
            <div class="risk-metric-item">
              <div class="risk-metric-label">Impact</div>
              <div class="risk-metric-value">${risk.impact}</div>
              <div class="small text-muted">${impactText}</div>
            </div>
            <div class="risk-metric-item">
              <div class="risk-metric-label">Risk Score</div>
              <div class="risk-score-badge risk-score-${riskScore}">${riskScore}</div>
            </div>
          </div>
        </div>
        ` : `
        <div class="alert alert-warning">
          <small>
            <i class="bi bi-exclamation-triangle me-1"></i>
            Risk assessment data not available for this risk.
          </small>
        </div>
        `}
        
        <div class="risk-card-footer">
          <div class="risk-card-metadata">
            <i class="bi bi-database me-1"></i>
            From database
            ${risk.modifiedDate ? `<span class="text-muted ms-2">• Last updated: ${new Date(risk.modifiedDate).toLocaleDateString()}</span>` : ''}
          </div>
          <div class="risk-card-actions">
            <button class="btn btn-outline-primary btn-sm edit-risk-btn" 
                    data-risk-id="${risk.id}" 
                    onclick="console.log('🔘 Edit button clicked for risk:', '${risk.id}'); startInlineEdit('${risk.id}')"
                    title="Edit risk details">
              <i class="bi bi-pencil me-1"></i>Edit
            </button>
            <div class="inline-edit-actions" style="display: none;">
              <button class="btn btn-success btn-sm me-1" 
                      onclick="saveInlineEdit('${risk.id}')"
                      title="Save changes">
                <i class="bi bi-check-lg me-1"></i>Save
              </button>
              <button class="btn btn-secondary btn-sm" 
                      onclick="cancelInlineEdit('${risk.id}')"
                      title="Cancel editing">
                <i class="bi bi-x-lg me-1"></i>Cancel
              </button>
            </div>
          </div>
        </div>
      </div>
      `;
    }).join('');
    
    console.log('✅ Updated existing risks display with', this.existingRisks.length, 'risks');
    this.updateCounts();
  }

  getMockExistingRisks() {
    // Mock data representing existing risks from database
    const processRisks = {
      'loan-origination': [
        {
          id: 'existing-1',
          title: 'Unauthorized Wire Transfers',
          category: 'Fraud',
          description: 'Risk of fraudulent wire transfers due to inadequate authorization controls.',
          likelihood: 4,
          impact: 5,
          source: 'existing',
          lastUpdated: '2024-01-15'
        },
        {
          id: 'existing-2', 
          title: 'Documentation Compliance Failure',
          category: 'Compliance',
          description: 'Risk of regulatory violations due to incomplete loan documentation.',
          likelihood: 3,
          impact: 4,
          source: 'existing',
          lastUpdated: '2024-01-10'
        }
      ],
      'account-opening': [
        {
          id: 'existing-3',
          title: 'Identity Verification Bypass',
          category: 'Operational',
          description: 'Risk of fraudulent account opening due to inadequate KYC procedures.',
          likelihood: 3,
          impact: 4,
          source: 'existing',
          lastUpdated: '2024-01-12'
        }
      ]
    };

    return processRisks[this.selectedProcess] || [];
  }

  // renderExistingRisks() removed - using updateExistingRisksDisplay() for inline editing

  async generateAISuggestions() {
    try {
      // Simulate AI generation delay
      setTimeout(() => {
        const aiSuggestions = this.getMockAISuggestions();
        this.aiSuggestedRisks = aiSuggestions;
        this.renderAISuggestions();
        this.updateCounts();
      }, 2500);
    } catch (error) {
      console.error('Failed to generate AI suggestions:', error);
      this.showAIError();
    }
  }

  getMockAISuggestions() {
    const suggestions = {
      'loan-origination': [
        {
          id: 'ai-1',
          title: 'Credit Risk Assessment Inadequacy',
          category: 'Credit',
          description: 'Insufficient credit analysis leading to loan defaults and financial losses.',
          likelihood: 3,
          impact: 4,
          source: 'ai',
          rationale: 'Common in loan origination processes, especially with complex financial products.'
        },
        {
          id: 'ai-2',
          title: 'System Integration Failures',
          category: 'Technology',
          description: 'Risk of data inconsistencies between loan origination and core banking systems.',
          likelihood: 2,
          impact: 3,
          source: 'ai',
          rationale: 'System integrations are common failure points in banking operations.'
        },
        {
          id: 'ai-3',
          title: 'Regulatory Reporting Delays',
          category: 'Compliance',
          description: 'Risk of late or inaccurate regulatory reporting due to process inefficiencies.',
          likelihood: 3,
          impact: 3,
          source: 'ai',
          rationale: 'Regulatory compliance requires timely and accurate reporting processes.'
        }
      ],
      'account-opening': [
        {
          id: 'ai-4',
          title: 'KYC Process Failure',
          category: 'Compliance',
          description: 'Inadequate Know Your Customer procedures leading to regulatory violations.',
          likelihood: 3,
          impact: 4,
          source: 'ai',
          rationale: 'KYC is fundamental to banking compliance and anti-money laundering efforts.'
        },
        {
          id: 'ai-5',
          title: 'Data Privacy Breach',
          category: 'Technology',
          description: 'Risk of customer data exposure during account opening process.',
          likelihood: 2,
          impact: 5,
          source: 'ai',
          rationale: 'Account opening involves collection of sensitive personal information.'
        }
      ]
    };

    return suggestions[this.selectedProcess] || suggestions['loan-origination'];
  }

  renderAISuggestions() {
    const container = document.getElementById('aiRisksContainer');
    
    container.innerHTML = this.aiSuggestedRisks.map(risk => {
      const categoryClass = this.getCategoryClass(risk.category);
      const riskScore = risk.likelihood * risk.impact;
      const likelihoodText = this.getLikelihoodText(risk.likelihood);
      const impactText = this.getImpactText(risk.impact);
      
      return `
      <div class="risk-card ai-suggested" data-risk-id="${risk.id}">
        <div class="risk-card-header">
          <h5 class="risk-card-title">${risk.title}</h5>
          <span class="risk-category-badge ${categoryClass}">${risk.category}</span>
        </div>
        
        <div class="risk-card-description">
          ${risk.description}
        </div>
        
        <div class="risk-metrics">
          <div class="risk-metrics-header">
            <i class="bi bi-robot"></i>
            AI Assessment
            </div>
          <div class="risk-metrics-grid">
            <div class="risk-metric-item">
              <div class="risk-metric-label">Likelihood</div>
              <div class="risk-metric-value">${risk.likelihood}</div>
              <div class="small text-muted">${likelihoodText}</div>
              </div>
            <div class="risk-metric-item">
              <div class="risk-metric-label">Impact</div>
              <div class="risk-metric-value">${risk.impact}</div>
              <div class="small text-muted">${impactText}</div>
            </div>
            <div class="risk-metric-item">
              <div class="risk-metric-label">Risk Score</div>
              <div class="risk-score-badge risk-score-${riskScore}">${riskScore}</div>
            </div>
          </div>
        </div>
        
        <div class="alert alert-info p-2 mb-3">
          <small>
            <i class="bi bi-lightbulb me-1"></i>
            <strong>AI Rationale:</strong> ${risk.rationale}
          </small>
        </div>
        
        <div class="risk-card-footer">
          <div class="risk-card-metadata">
            <i class="bi bi-robot me-1"></i>
            AI Generated
          </div>
          <div class="risk-card-actions">
            <button class="btn btn-success btn-sm" onclick="acceptAIRisk('${risk.id}')">
              <i class="bi bi-check-lg me-1"></i>Accept
            </button>
            <button class="btn btn-warning btn-sm" onclick="modifyAIRisk('${risk.id}')">
              <i class="bi bi-pencil me-1"></i>Modify
            </button>
            <button class="btn btn-outline-danger btn-sm" onclick="rejectAIRisk('${risk.id}')">
              <i class="bi bi-x-lg me-1"></i>Reject
            </button>
          </div>
        </div>
      </div>
      `;
    }).join('');
  }

  addCustomRisk() {
    const title = document.getElementById('customRiskTitle').value;
    const category = document.getElementById('customRiskCategory').value;
    const description = document.getElementById('customRiskDescription').value;
    const likelihood = parseInt(document.getElementById('customRiskLikelihood').value);
    const impact = parseInt(document.getElementById('customRiskImpact').value);

    const customRisk = {
      id: `custom-${Date.now()}`,
      title,
      category,
      description,
      likelihood,
      impact,
      source: 'custom',
      timestamp: new Date().toISOString()
    };

    this.customRisks.push(customRisk);
    this.renderCustomRisks();
    this.updateCounts();
    this.clearCustomRiskForm();
    
    if (typeof modernInteractions !== 'undefined') {
      modernInteractions.showSuccess('Custom Risk Added', `"${title}" has been added successfully`);
    }
  }

  renderCustomRisks() {
    const placeholder = document.getElementById('customRisksEmpty');
    const customContainer = document.getElementById('customRisksDisplay');
    
    // Defensive programming - ensure arrays are always defined
    const customRisks = this.customRisks || [];
    
    if (!placeholder || !customContainer) {
      console.warn('Custom risks containers not found');
      return;
    }
    
    if (customRisks.length === 0) {
      placeholder.style.display = 'block';
      customContainer.style.display = 'none';
      return;
    }
    
    placeholder.style.display = 'none';
    customContainer.style.display = 'block';
    
    customContainer.innerHTML = customRisks.map(risk => {
      const categoryClass = this.getCategoryClass(risk.category);
      const riskScore = (risk.likelihood || 1) * (risk.impact || 1);
      const likelihoodText = this.getLikelihoodText(risk.likelihood);
      const impactText = this.getImpactText(risk.impact);
      
      return `
      <div class="risk-card custom" data-risk-id="${risk.id}">
        <div class="risk-card-header">
          <h5 class="risk-card-title">${risk.title || 'Untitled Risk'}</h5>
          <span class="risk-category-badge ${categoryClass}">${risk.category || 'Other'}</span>
        </div>
        
        <div class="risk-card-description">
          ${risk.description || 'No description provided'}
        </div>
        
        <div class="risk-metrics">
          <div class="risk-metrics-header">
            <i class="bi bi-person"></i>
            Custom Assessment
            </div>
          <div class="risk-metrics-grid">
            <div class="risk-metric-item">
              <div class="risk-metric-label">Likelihood</div>
              <div class="risk-metric-value">${risk.likelihood || 'N/A'}</div>
              <div class="small text-muted">${risk.likelihood ? likelihoodText : 'Not set'}</div>
              </div>
            <div class="risk-metric-item">
              <div class="risk-metric-label">Impact</div>
              <div class="risk-metric-value">${risk.impact || 'N/A'}</div>
              <div class="small text-muted">${risk.impact ? impactText : 'Not set'}</div>
            </div>
            <div class="risk-metric-item">
              <div class="risk-metric-label">Risk Score</div>
              <div class="risk-score-badge risk-score-${riskScore}">${riskScore}</div>
            </div>
          </div>
        </div>
        
        <div class="risk-card-footer">
          <div class="risk-card-metadata">
            <i class="bi bi-person me-1"></i>
            Added: ${risk.timestamp ? new Date(risk.timestamp).toLocaleDateString() : 'Unknown'}
          </div>
          <div class="risk-card-actions">
          <button class="btn btn-outline-danger btn-sm" onclick="removeCustomRisk('${risk.id}')">
            <i class="bi bi-trash me-1"></i>Remove
          </button>
        </div>
      </div>
      </div>
      `;
    }).join('');
  }

  updateCounts() {
    // Defensive programming - ensure arrays are always defined
    const existingCount = (this.existingRisks || []).length;
    const aiCount = (this.acceptedAiRisks || []).length;
    const customCount = (this.customRisks || []).length;
    const totalCount = existingCount + aiCount + customCount;

    // Safely update DOM elements
    const existingRiskCountEl = document.getElementById('existingRiskCount');
    const aiRiskCountEl = document.getElementById('aiRiskCount');
    const totalRiskCountEl = document.getElementById('totalRiskCount');
    const existingCountEl = document.getElementById('existingCount');
    const aiCountEl = document.getElementById('aiCount');
    const customCountEl = document.getElementById('customCount');
    const continueBtn = document.getElementById('continueBtn');

    if (existingRiskCountEl) existingRiskCountEl.textContent = `${existingCount} Found`;
    if (aiRiskCountEl) aiRiskCountEl.textContent = `${aiCount} Added`;
    if (totalRiskCountEl) totalRiskCountEl.textContent = totalCount;
    if (existingCountEl) existingCountEl.textContent = existingCount;
    if (aiCountEl) aiCountEl.textContent = aiCount;
    if (customCountEl) customCountEl.textContent = customCount;

    // Enable continue button if we have any risks
    if (continueBtn) {
      continueBtn.disabled = totalCount === 0;
    }
  }

  getCategoryColor(category) {
    const colors = {
      'Operational': 'warning',
      'Technology': 'info',
      'Fraud': 'danger',
      'Compliance': 'primary',
      'Credit': 'success'
    };
    return colors[category] || 'secondary';
  }

  getCategoryClass(category) {
    const classes = {
      'Operational': 'risk-category-operational',
      'Technology': 'risk-category-technology',
      'Fraud': 'risk-category-fraud',
      'Compliance': 'risk-category-compliance',
      'Credit': 'risk-category-credit'
    };
    return classes[category] || 'risk-category-operational';
  }

  getLikelihoodText(likelihood) {
    const texts = {
      1: 'Very Low',
      2: 'Low',
      3: 'Medium',
      4: 'High',
      5: 'Very High'
    };
    return texts[likelihood] || 'Unknown';
  }

  getImpactText(impact) {
    const texts = {
      1: 'Negligible',
      2: 'Minor',
      3: 'Moderate',
      4: 'Major',
      5: 'Severe'
    };
    return texts[impact] || 'Unknown';
  }

  clearCustomRiskForm() {
    document.getElementById('addCustomRiskForm').reset();
    toggleCustomRiskForm();
  }

  continueToNextStep() {
    // Store all identified risks for next step
    const allRisks = [
      ...this.existingRisks,
      ...this.acceptedAiRisks,
      ...this.customRisks
    ];
    
    sessionStorage.setItem('rcsa_identified_risks', JSON.stringify(allRisks));
    
    if (typeof modernInteractions !== 'undefined') {
      modernInteractions.showSuccess('Proceeding', 'Moving to Control Mapping...');
    }
    
    setTimeout(() => {
      window.location.href = '/Control-Mapping-Overview';
    }, 1500);
  }

  showExistingRisksError() {
    document.getElementById('existingRisksContainer').innerHTML = `
      <div class="empty-state">
        <i class="bi bi-exclamation-triangle display-1 text-warning mb-3"></i>
        <h5 class="text-muted">Unable to Load Existing Risks</h5>
        <p class="text-muted">There was an error loading existing risks from the database.</p>
        <button class="btn btn-outline-primary" onclick="location.reload()">
          <i class="bi bi-arrow-clockwise me-1"></i>Retry
        </button>
      </div>
    `;
  }

  showAIError() {
    document.getElementById('aiRisksContainer').innerHTML = `
      <div class="empty-state">
        <i class="bi bi-exclamation-triangle display-1 text-warning mb-3"></i>
        <h5 class="text-muted">AI Service Unavailable</h5>
        <p class="text-muted">Unable to generate AI suggestions at this time.</p>
        <button class="btn btn-outline-success" onclick="riskIdentification.generateAISuggestions()">
          <i class="bi bi-arrow-clockwise me-1"></i>Retry AI Suggestions
        </button>
      </div>
    `;
  }

  updateUI() {
    this.updateCounts();
  }
}

// Global functions for button actions
function toggleCustomRiskForm() {
  const form = document.getElementById('customRiskForm');
  const placeholder = document.getElementById('customRisksEmpty');
  
  // Check if we have custom risks to determine if we should show placeholder
  const hasCustomRisks = riskIdentification && riskIdentification.customRisks && riskIdentification.customRisks.length > 0;
  
  if (form.style.display === 'none') {
    form.style.display = 'block';
    // Only hide placeholder if no custom risks exist
    if (!hasCustomRisks) {
      placeholder.style.display = 'none';
    }
  } else {
    form.style.display = 'none';
    // Only show placeholder if no custom risks exist
    if (!hasCustomRisks) {
      placeholder.style.display = 'block';
    }
  }
}

function acceptAIRisk(riskId) {
  const risk = riskIdentification.aiSuggestedRisks.find(r => r.id === riskId);
  if (risk) {
    riskIdentification.acceptedAiRisks.push(risk);
    
    // Update the risk card to show accepted state
    const riskCard = document.querySelector(`[data-risk-id="${riskId}"]`);
    riskCard.classList.add('accepted');
    riskCard.querySelector('.btn-group').innerHTML = `
      <button class="btn btn-success btn-sm" disabled>
        <i class="bi bi-check-lg me-1"></i>Accepted
      </button>
      <button class="btn btn-outline-secondary btn-sm" onclick="undoAcceptAIRisk('${riskId}')">
        <i class="bi bi-arrow-counterclockwise me-1"></i>Undo
      </button>
    `;
    
    riskIdentification.updateCounts();
    
    if (typeof modernInteractions !== 'undefined') {
      modernInteractions.showSuccess('Risk Accepted', `"${risk.title}" has been accepted`);
    }
  }
}

function undoAcceptAIRisk(riskId) {
  riskIdentification.acceptedAiRisks = riskIdentification.acceptedAiRisks.filter(r => r.id !== riskId);
  
  // Reset the risk card
  const riskCard = document.querySelector(`[data-risk-id="${riskId}"]`);
  riskCard.classList.remove('accepted');
  riskCard.querySelector('.btn-group').innerHTML = `
    <button class="btn btn-success btn-sm" onclick="acceptAIRisk('${riskId}')">
      <i class="bi bi-check-lg me-1"></i>Accept
    </button>
    <button class="btn btn-warning btn-sm" onclick="modifyAIRisk('${riskId}')">
      <i class="bi bi-pencil me-1"></i>Modify
    </button>
    <button class="btn btn-outline-danger btn-sm" onclick="rejectAIRisk('${riskId}')">
      <i class="bi bi-x-lg me-1"></i>Reject
    </button>
  `;
  
  riskIdentification.updateCounts();
}

function rejectAIRisk(riskId) {
  const riskCard = document.querySelector(`[data-risk-id="${riskId}"]`);
  riskCard.classList.add('rejected');
  
  if (typeof modernInteractions !== 'undefined') {
    modernInteractions.showWarning('Risk Rejected', 'Risk has been rejected');
  }
}

function modifyAIRisk(riskId) {
  const risk = riskIdentification.aiSuggestedRisks.find(r => r.id === riskId);
  if (risk) {
    showRiskEditModal(risk, 'ai');
  }
}

// editExistingRisk() removed - using inline editing only

function showRiskEditModal(risk, type) {
  // Create modal HTML
  const modalHtml = `
    <div class="modal fade" id="editRiskModal" tabindex="-1" aria-labelledby="editRiskModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editRiskModalLabel">
              <i class="bi bi-pencil me-2"></i>Edit Risk
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="editRiskForm">
              <div class="mb-3">
                <label for="editRiskTitle" class="form-label">Risk Title</label>
                <input type="text" class="form-control" id="editRiskTitle" value="${risk.title}" required>
              </div>
              
              <div class="mb-3">
                <label for="editRiskCategory" class="form-label">Category</label>
                <select class="form-select" id="editRiskCategory" required>
                  <option value="Operational" ${risk.category === 'Operational' ? 'selected' : ''}>Operational</option>
                  <option value="Technology" ${risk.category === 'Technology' ? 'selected' : ''}>Technology</option>
                  <option value="Fraud" ${risk.category === 'Fraud' ? 'selected' : ''}>Fraud</option>
                  <option value="Compliance" ${risk.category === 'Compliance' ? 'selected' : ''}>Compliance</option>
                  <option value="Credit" ${risk.category === 'Credit' ? 'selected' : ''}>Credit</option>
                </select>
              </div>
              
              <div class="mb-3">
                <label for="editRiskDescription" class="form-label">Description</label>
                <textarea class="form-control" id="editRiskDescription" rows="3" required>${risk.description}</textarea>
              </div>
              
              <div class="row">
                <div class="col-md-6">
                  <label for="editRiskLikelihood" class="form-label">Likelihood (1-5)</label>
                  <select class="form-select" id="editRiskLikelihood" required>
                    <option value="1" ${risk.likelihood === 1 ? 'selected' : ''}>1 - Very Low</option>
                    <option value="2" ${risk.likelihood === 2 ? 'selected' : ''}>2 - Low</option>
                    <option value="3" ${risk.likelihood === 3 ? 'selected' : ''}>3 - Medium</option>
                    <option value="4" ${risk.likelihood === 4 ? 'selected' : ''}>4 - High</option>
                    <option value="5" ${risk.likelihood === 5 ? 'selected' : ''}>5 - Very High</option>
                  </select>
                </div>
                <div class="col-md-6">
                  <label for="editRiskImpact" class="form-label">Impact (1-5)</label>
                  <select class="form-select" id="editRiskImpact" required>
                    <option value="1" ${risk.impact === 1 ? 'selected' : ''}>1 - Very Low</option>
                    <option value="2" ${risk.impact === 2 ? 'selected' : ''}>2 - Low</option>
                    <option value="3" ${risk.impact === 3 ? 'selected' : ''}>3 - Medium</option>
                    <option value="4" ${risk.impact === 4 ? 'selected' : ''}>4 - High</option>
                    <option value="5" ${risk.impact === 5 ? 'selected' : ''}>5 - Very High</option>
                  </select>
                </div>
              </div>
              
              ${type === 'ai' ? `
              <div class="mt-3">
                <label for="editRiskRationale" class="form-label">AI Rationale</label>
                <textarea class="form-control" id="editRiskRationale" rows="2">${risk.rationale || ''}</textarea>
              </div>
              ` : ''}
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="saveRiskEdit('${risk.id}', '${type}')">
              <i class="bi bi-check-lg me-1"></i>Save Changes
            </button>
          </div>
        </div>
      </div>
    </div>
  `;
  
  try {
    // Remove existing modal if any
    const existingModal = document.getElementById('editRiskModal');
    if (existingModal) {
      existingModal.remove();
    }
    
    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal with fallback
    if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
      const modal = new bootstrap.Modal(document.getElementById('editRiskModal'));
      modal.show();
    } else {
      // Fallback: show modal manually
      const modalElement = document.getElementById('editRiskModal');
      modalElement.style.display = 'block';
      modalElement.classList.add('show');
      document.body.classList.add('modal-open');
      
      // Add backdrop
      const backdrop = document.createElement('div');
      backdrop.className = 'modal-backdrop fade show';
      backdrop.id = 'editRiskBackdrop';
      document.body.appendChild(backdrop);
      
      // Add close handlers
      modalElement.querySelector('.btn-close').onclick = closeEditModal;
      modalElement.querySelector('[data-bs-dismiss="modal"]').onclick = closeEditModal;
      backdrop.onclick = closeEditModal;
    }
    
    if (typeof modernInteractions !== 'undefined') {
      modernInteractions.showInfo('Edit Risk', 'Risk edit dialog opened');
    }
  } catch (error) {
    console.error('Error showing edit modal:', error);
    if (typeof modernInteractions !== 'undefined') {
      modernInteractions.showError('Error', 'Unable to open edit dialog. Please try again.');
    }
  }
}

function closeEditModal() {
  try {
    const modal = document.getElementById('editRiskModal');
    const backdrop = document.getElementById('editRiskBackdrop');
    
    if (modal) {
      modal.style.display = 'none';
      modal.classList.remove('show');
      modal.remove();
    }
    
    if (backdrop) {
      backdrop.remove();
    }
    
    document.body.classList.remove('modal-open');
  } catch (error) {
    console.error('Error closing modal:', error);
  }
}

// Helper function to get anti-forgery token
function getAntiForgeryToken() {
  try {
    // Power Pages typically includes the token in existing forms or as a hidden field
    // Method 1: Check all input fields for the token
    const tokenInputs = document.querySelectorAll('input[name="__RequestVerificationToken"]');
    if (tokenInputs.length > 0) {
      console.log('🔍 DEBUG: Found anti-forgery token in input field');
      return tokenInputs[0].value;
    }
    
    // Method 2: Check meta tags
    const metaToken = document.querySelector('meta[name="__RequestVerificationToken"]');
    if (metaToken) {
      console.log('🔍 DEBUG: Found anti-forgery token in meta tag');
      return metaToken.content;
    }
    
    // Method 3: Check if it's in the page's JavaScript context
    if (typeof __RequestVerificationToken !== 'undefined') {
      console.log('🔍 DEBUG: Found anti-forgery token in global variable');
      return __RequestVerificationToken;
    }
    
    // Method 4: Try to get from shell API if available
    if (window.shell && window.shell.getTokenDeferred) {
      console.log('🔍 DEBUG: Attempting to get token from shell API');
      const tokenDeferred = window.shell.getTokenDeferred();
      if (tokenDeferred && tokenDeferred.promise) {
        return tokenDeferred.promise();
      }
    }
    
    console.log('⚠️ DEBUG: No anti-forgery token found - Web API calls may fail');
    return null;
  } catch (error) {
    console.error('❌ Error getting anti-forgery token:', error);
    return null;
  }
}

async function saveRiskToDataverse(riskId, riskData) {
  console.log('🔍 DEBUG: Starting saveRiskToDataverse', { riskId, riskData });
  
  try {
    // Get anti-forgery token
    const token = getAntiForgeryToken();
    console.log('🔍 DEBUG: Anti-forgery token:', token ? 'Found' : 'Not found');
    
    const requestBody = {
      'cr129_risktitle': riskData.title,
      'cr129_description': riskData.description,
      'cr129_riskcategory': getCategoryValue(riskData.category),
      'cr129_inherentlikelihood': riskData.likelihood,
      'cr129_inherentimpact': riskData.impact
    };
    
    console.log('🔍 DEBUG: Request body:', requestBody);
    console.log('🔍 DEBUG: API URL:', `/_api/cr129_risks(${riskId})`);
    
    // Build headers with anti-forgery token
    const headers = {
      'Content-Type': 'application/json',
      'Accept': 'application/json',
      'OData-MaxVersion': '4.0',
      'OData-Version': '4.0'
    };
    
    if (token) {
      headers['__RequestVerificationToken'] = token;
    }
    
    console.log('🔍 DEBUG: Request headers:', headers);
    
    // Use Power Pages Web API to update the risk record
    const response = await fetch(`/_api/cr129_risks(${riskId})`, {
      method: 'PATCH',
      headers: headers,
      body: JSON.stringify(requestBody)
    });

    console.log('🔍 DEBUG: Response status:', response.status);
    console.log('🔍 DEBUG: Response headers:', [...response.headers.entries()]);
    
    if (!response.ok) {
      const errorText = await response.text();
      console.error('❌ DEBUG: Response error text:', errorText);
      throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
    }

    console.log('✅ Risk successfully updated in Dataverse');
    return response;
  } catch (error) {
    console.error('❌ Error updating risk in Dataverse:', error);
    console.error('❌ Error details:', {
      name: error.name,
      message: error.message,
      stack: error.stack
    });
    
    // Check if it's a permission error
    if (error.message.includes('403') || error.message.includes('Forbidden')) {
      console.error('❌ Permission Error: Web API write access may be disabled for cr129_risk entity');
      console.error('❌ Check table permissions in Power Pages admin center');
    }
    
    throw error;
  }
}

function getCategoryValue(categoryLabel) {
  const categoryMap = {
    'Operational': 798060000,
    'Technology': 798060001,
    'Fraud': 798060002,
    'Compliance': 798060003,
    'Credit': 798060004
  };
  return categoryMap[categoryLabel] || 798060000;
}

// Test Web API function removed for cleaner UI

function saveRiskEdit(riskId, type) {
  try {
    const title = document.getElementById('editRiskTitle').value;
    const category = document.getElementById('editRiskCategory').value;
    const description = document.getElementById('editRiskDescription').value;
    const likelihood = parseInt(document.getElementById('editRiskLikelihood').value);
    const impact = parseInt(document.getElementById('editRiskImpact').value);
    const rationale = document.getElementById('editRiskRationale')?.value;
    
    if (!title || !category || !description) {
      if (typeof modernInteractions !== 'undefined') {
        modernInteractions.showError('Validation Error', 'Please fill in all required fields');
      }
      return;
    }
    
    if (type === 'existing') {
      // Update existing risk in Dataverse
      saveRiskToDataverse(riskId, {
        title,
        category,
        description,
        likelihood,
        impact
      }).then(() => {
        // Update local array only after successful save
      const riskIndex = riskIdentification.existingRisks.findIndex(r => r.id === riskId);
      if (riskIndex !== -1) {
        riskIdentification.existingRisks[riskIndex] = {
          ...riskIdentification.existingRisks[riskIndex],
          title,
          category,
          description,
          likelihood,
          impact
        };
          riskIdentification.updateExistingRisksDisplay();
        }
      }).catch(error => {
        console.error('Error saving to Dataverse:', error);
        if (typeof modernInteractions !== 'undefined') {
          modernInteractions.showError('Save Failed', 'Unable to save changes to database. Please try again.');
        }
        return; // Don't close modal on error
      });
    } else if (type === 'ai') {
      // Update AI risk
      const riskIndex = riskIdentification.aiSuggestedRisks.findIndex(r => r.id === riskId);
      if (riskIndex !== -1) {
        riskIdentification.aiSuggestedRisks[riskIndex] = {
          ...riskIdentification.aiSuggestedRisks[riskIndex],
          title,
          category,
          description,
          likelihood,
          impact,
          rationale
        };
        riskIdentification.renderAISuggestions();
      }
    }
    
    // Close modal
    if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
      const modal = bootstrap.Modal.getInstance(document.getElementById('editRiskModal'));
      if (modal) {
        modal.hide();
      }
    } else {
      closeEditModal();
    }
    
    if (typeof modernInteractions !== 'undefined') {
      modernInteractions.showSuccess('Risk Updated', `"${title}" has been updated successfully`);
    }
  } catch (error) {
    console.error('Error saving risk edit:', error);
    if (typeof modernInteractions !== 'undefined') {
      modernInteractions.showError('Error', 'Unable to save changes. Please try again.');
    }
  }
}

// Add unlink checkbox to the edit form
function addUnlinkCheckbox(iframeDoc) {
  try {
    // Find the process field in the form
    const processField = iframeDoc.querySelector('[name*="processname"], [id*="processname"], [data-name*="processname"]');
    if (!processField) {
      console.log('Process field not found, trying alternative selectors...');
      // Try to find any lookup field that might be the process
      const lookupFields = iframeDoc.querySelectorAll('.lookup-field, .form-control[type="text"][readonly]');
      console.log('Found lookup fields:', lookupFields.length);
      return;
    }
    
    // Find the parent form group
    const formGroup = processField.closest('.form-group, .control-group, fieldset, .row');
    if (!formGroup) {
      console.log('Form group not found');
      return;
    }
    
    // Create unlink checkbox section
    const unlinkSection = iframeDoc.createElement('div');
    unlinkSection.className = 'unlink-section';
    unlinkSection.innerHTML = `
      <div class="form-check">
        <input type="checkbox" class="form-check-input unlink-checkbox" id="unlinkFromProcess">
        <label class="form-check-label" for="unlinkFromProcess">
          <strong><i class="bi bi-link-45deg me-1"></i>Unlink this risk from the current process</strong>
          <br>
          <small class="text-muted">Check this box to remove the process association. The risk will remain in the database.</small>
        </label>
      </div>
    `;
    
    // Insert after the process field
    formGroup.parentNode.insertBefore(unlinkSection, formGroup.nextSibling);
    
    // Add checkbox change handler
    const unlinkCheckbox = iframeDoc.getElementById('unlinkFromProcess');
    unlinkCheckbox.addEventListener('change', function() {
      if (this.checked) {
        // Clear the process field
        if (processField.value) {
          processField.value = '';
          processField.setAttribute('data-original-value', processField.value);
        }
        
        // If it's a lookup field with a hidden ID field
        const processIdField = iframeDoc.querySelector('[name*="processnameid"], [id*="processnameid"]');
        if (processIdField) {
          processIdField.value = '';
        }
        
        // Disable the process field
        processField.disabled = true;
        processField.style.opacity = '0.5';
        
        // Show confirmation
        const confirmDiv = iframeDoc.createElement('div');
        confirmDiv.className = 'alert alert-warning mt-2';
        confirmDiv.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>Process will be unlinked when you save the form.';
        unlinkSection.appendChild(confirmDiv);
      } else {
        // Re-enable the process field
        processField.disabled = false;
        processField.style.opacity = '1';
        
        // Remove confirmation
        const confirmDiv = unlinkSection.querySelector('.alert');
        if (confirmDiv) confirmDiv.remove();
      }
    });
    
    console.log('✅ Unlink checkbox added successfully');
    
  } catch (error) {
    console.error('Error adding unlink checkbox:', error);
  }
}

// Simplified unlink button - just shows instructions
function simpleUnlinkRisk(riskId, riskTitle) {
  alert(`To unlink "${riskTitle}" from this process:\n\n1. Click the Edit button\n2. Check the "Unlink from process" checkbox\n3. Click Save\n\nThis will permanently remove the process association.`);
}

function removeCustomRisk(riskId) {
  if (confirm('Are you sure you want to remove this custom risk?')) {
    riskIdentification.customRisks = riskIdentification.customRisks.filter(r => r.id !== riskId);
    riskIdentification.renderCustomRisks();
    riskIdentification.updateCounts();
    
    if (typeof modernInteractions !== 'undefined') {
      modernInteractions.showWarning('Risk Removed', 'Custom risk has been removed');
    }
  }
}

function goBack() {
  if (typeof modernInteractions !== 'undefined') {
    modernInteractions.showInfo('Returning to Process Selection', 'Redirecting...');
  }
  
  setTimeout(() => {
    window.location.href = '/Process-Selection';
  }, 1000);
}

// Initialize when DOM is ready
let riskIdentification;
document.addEventListener('DOMContentLoaded', function() {
  try {
    console.log('🚀 Initializing Enhanced Risk Identification...');
    riskIdentification = new EnhancedRiskIdentification();
    console.log('✅ Enhanced Risk Identification initialized successfully');
    
    if (typeof modernInteractions !== 'undefined') {
      modernInteractions.showSuccess('Page Ready', 'Enhanced Risk Identification loaded successfully!');
    }
  } catch (error) {
    console.error('❌ Error initializing Risk Identification:', error);
  }
});

// Global error handler to catch any unhandled errors
window.addEventListener('error', function(event) {
  // Only log our own errors, not third-party ones
  if (event.filename && event.filename.includes('Risk-ID')) {
    console.error('🔥 Risk Identification Error:', {
      message: event.message,
      filename: event.filename,
      lineno: event.lineno,
      colno: event.colno,
      error: event.error
    });
  }
});

// View toggle functionality removed for cleaner UI

// Offcanvas Panel Handler - Fixed to work with page reload
window.addEventListener('load', function() {
  // Auto-open offcanvas if ID is in URL
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.has('id')) {
    console.log('🔍 Risk ID found in URL, opening edit panel...');
    const offcanvasElement = document.getElementById('riskEditPanel');
    if (offcanvasElement) {
      const offcanvas = new bootstrap.Offcanvas(offcanvasElement);
      offcanvas.show();
    }
  }
  
  // Clean URL when offcanvas closes
  const riskEditPanel = document.getElementById('riskEditPanel');
  if (riskEditPanel) {
    riskEditPanel.addEventListener('hidden.bs.offcanvas', function() {
      console.log('🧹 Cleaning URL after panel close...');
      window.history.replaceState({}, '', window.location.pathname);
    });
  }
  
  // Handle form success
  document.addEventListener('pp-entityform-success', function() {
    if (typeof modernInteractions !== 'undefined') {
      modernInteractions.showSuccess('Success', 'Risk updated successfully!');
    }
    
    // Close offcanvas and refresh
    setTimeout(function() {
      const offcanvasElement = document.getElementById('riskEditPanel');
      if (offcanvasElement) {
        const offcanvas = bootstrap.Offcanvas.getInstance(offcanvasElement);
        if (offcanvas) {
          offcanvas.hide();
        }
      }
      window.location.reload();
    }, 1000);
  });
});

// ============================================================================
// INLINE EDITING FUNCTIONALITY
// ============================================================================

// Store original values for cancel functionality
const originalValues = new Map();

// Test function to verify inline editing is working
window.testInlineEdit = function() {
  console.log('🧪 Testing inline edit functionality...');
  console.log('✅ startInlineEdit function exists:', typeof startInlineEdit);
  console.log('✅ originalValues Map exists:', originalValues instanceof Map);
  console.log('✅ riskCategories array exists:', Array.isArray(riskCategories));
  
  const cards = document.querySelectorAll('[data-risk-id]');
  console.log('✅ Found', cards.length, 'risk cards');
  
  if (cards.length > 0) {
    const firstCard = cards[0];
    const riskId = firstCard.dataset.riskId;
    console.log('🎯 First card risk ID:', riskId);
    console.log('🔘 Try clicking: startInlineEdit("' + riskId + '")');
  }
};

// Risk categories for dropdown
const riskCategories = [
  { value: 'Operational', label: 'Operational' },
  { value: 'Technology', label: 'Technology' },
  { value: 'Fraud', label: 'Fraud' },
  { value: 'Compliance', label: 'Compliance' },
  { value: 'Credit', label: 'Credit' },
  { value: 'Market', label: 'Market' },
  { value: 'Liquidity', label: 'Liquidity' },
  { value: 'Reputational', label: 'Reputational' }
];

// Risk status options
const riskStatuses = [
  { value: 100000000, label: 'Draft' },
  { value: 100000001, label: 'Under Review' },
  { value: 100000002, label: 'Approved' },
  { value: 100000003, label: 'Retired' }
];

// Start inline editing for a risk card
function startInlineEdit(riskId) {
  console.log('🔧 Starting inline edit for risk:', riskId);
  console.log('🔍 Function called successfully!');
  
  // Test if we can access all required elements
  console.log('📋 Testing element access...');
  
  const card = document.querySelector(`[data-risk-id="${riskId}"]`);
  if (!card) {
    console.error('Risk card not found:', riskId);
    return;
  }
  
  // Store original values for cancel functionality
  const originalData = extractRiskData(card);
  originalValues.set(riskId, originalData);
  
  // Add editing class to card
  card.classList.add('editing');
  
  // Convert fields to editable
  convertToEditable(card, originalData);
  
  // Show/hide appropriate buttons
  const editBtn = card.querySelector('.edit-risk-btn');
  const editActions = card.querySelector('.inline-edit-actions');
  
  if (editBtn) editBtn.style.display = 'none';
  if (editActions) editActions.style.display = 'inline-flex';
  
  console.log('✅ Inline edit started for risk:', riskId);
}

// Extract current risk data from card
function extractRiskData(card) {
  const titleElement = card.querySelector('.risk-card-title');
  const categoryElement = card.querySelector('.risk-category-badge');
  const descriptionElement = card.querySelector('.risk-card-description');
  const likelihoodElement = card.querySelector('.risk-metric-item:nth-child(1) .risk-metric-value');
  const impactElement = card.querySelector('.risk-metric-item:nth-child(2) .risk-metric-value');
  
  return {
    title: titleElement ? titleElement.textContent.trim() : '',
    category: categoryElement ? categoryElement.textContent.trim() : '',
    description: descriptionElement ? descriptionElement.textContent.trim() : '',
    likelihood: likelihoodElement ? parseInt(likelihoodElement.textContent) : null,
    impact: impactElement ? parseInt(impactElement.textContent) : null
  };
}

// Convert card fields to editable inputs
function convertToEditable(card, data) {
  // Convert title
  const titleElement = card.querySelector('.risk-card-title');
  if (titleElement) {
    titleElement.innerHTML = `
      <input type="text" 
             class="form-control form-control-sm inline-edit-input" 
             value="${data.title}" 
             data-field="title"
             placeholder="Enter risk title">
    `;
  }
  
  // Convert category
  const categoryElement = card.querySelector('.risk-category-badge');
  if (categoryElement) {
    const categoryOptions = riskCategories.map(cat => 
      `<option value="${cat.value}" ${cat.value === data.category ? 'selected' : ''}>${cat.label}</option>`
    ).join('');
    
    categoryElement.innerHTML = `
      <select class="form-select form-select-sm inline-edit-select" 
              data-field="category">
        <option value="">Select Category</option>
        ${categoryOptions}
      </select>
    `;
  }
  
  // Convert description
  const descriptionElement = card.querySelector('.risk-card-description');
  if (descriptionElement) {
    descriptionElement.innerHTML = `
      <textarea class="form-control form-control-sm inline-edit-textarea" 
                data-field="description" 
                rows="3" 
                placeholder="Enter risk description">${data.description}</textarea>
    `;
  }
  
  // Convert likelihood
  const likelihoodElement = card.querySelector('.risk-metric-item:nth-child(1) .risk-metric-value');
  if (likelihoodElement) {
    likelihoodElement.innerHTML = `
      <select class="form-select form-select-sm inline-edit-select" 
              data-field="likelihood">
        <option value="">-</option>
        <option value="1" ${data.likelihood === 1 ? 'selected' : ''}>1</option>
        <option value="2" ${data.likelihood === 2 ? 'selected' : ''}>2</option>
        <option value="3" ${data.likelihood === 3 ? 'selected' : ''}>3</option>
        <option value="4" ${data.likelihood === 4 ? 'selected' : ''}>4</option>
        <option value="5" ${data.likelihood === 5 ? 'selected' : ''}>5</option>
      </select>
    `;
  }
  
  // Convert impact
  const impactElement = card.querySelector('.risk-metric-item:nth-child(2) .risk-metric-value');
  if (impactElement) {
    impactElement.innerHTML = `
      <select class="form-select form-select-sm inline-edit-select" 
              data-field="impact">
        <option value="">-</option>
        <option value="1" ${data.impact === 1 ? 'selected' : ''}>1</option>
        <option value="2" ${data.impact === 2 ? 'selected' : ''}>2</option>
        <option value="3" ${data.impact === 3 ? 'selected' : ''}>3</option>
        <option value="4" ${data.impact === 4 ? 'selected' : ''}>4</option>
        <option value="5" ${data.impact === 5 ? 'selected' : ''}>5</option>
      </select>
    `;
  }
}

// Save inline edit changes
async function saveInlineEdit(riskId) {
  console.log('💾 Saving inline edit for risk:', riskId);
  
  const card = document.querySelector(`[data-risk-id="${riskId}"]`);
  if (!card) {
    console.error('Risk card not found:', riskId);
    return;
  }
  
  // Show loading state
  const saveBtn = card.querySelector('.inline-edit-actions .btn-success');
  const originalSaveText = saveBtn.innerHTML;
  saveBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Saving...';
  saveBtn.disabled = true;
  
  try {
    // Extract new values
    const newData = extractEditableValues(card);
    
    // Validate required fields
    if (!newData.title.trim()) {
      throw new Error('Risk title is required');
    }
    
    if (!newData.category) {
      throw new Error('Risk category is required');
    }
    
    // TODO: Replace with actual Dataverse API call
    await saveToDataverse(riskId, newData);
    
    // Update card display with new values
    updateCardDisplay(card, newData);
    
    // Exit edit mode
    exitEditMode(card, riskId);
    
    // Show success message
    showSuccessMessage('Risk updated successfully!');
    
    console.log('✅ Risk saved successfully:', riskId);
    
  } catch (error) {
    console.error('❌ Error saving risk:', error);
    showErrorMessage(error.message || 'Failed to save risk. Please try again.');
    
    // Restore button state
    saveBtn.innerHTML = originalSaveText;
    saveBtn.disabled = false;
  }
}

// Cancel inline editing
function cancelInlineEdit(riskId) {
  console.log('❌ Cancelling inline edit for risk:', riskId);
  
  const card = document.querySelector(`[data-risk-id="${riskId}"]`);
  if (!card) {
    console.error('Risk card not found:', riskId);
    return;
  }
  
  // Restore original values
  const originalData = originalValues.get(riskId);
  if (originalData) {
    updateCardDisplay(card, originalData);
  }
  
  // Exit edit mode
  exitEditMode(card, riskId);
  
  console.log('✅ Inline edit cancelled for risk:', riskId);
}

// Extract values from editable fields
function extractEditableValues(card) {
  const titleInput = card.querySelector('[data-field="title"]');
  const categorySelect = card.querySelector('[data-field="category"]');
  const descriptionTextarea = card.querySelector('[data-field="description"]');
  const likelihoodSelect = card.querySelector('[data-field="likelihood"]');
  const impactSelect = card.querySelector('[data-field="impact"]');
  
  return {
    title: titleInput ? titleInput.value.trim() : '',
    category: categorySelect ? categorySelect.value : '',
    description: descriptionTextarea ? descriptionTextarea.value.trim() : '',
    likelihood: likelihoodSelect ? parseInt(likelihoodSelect.value) || null : null,
    impact: impactSelect ? parseInt(impactSelect.value) || null : null
  };
}

// Update card display with new values
function updateCardDisplay(card, data) {
  // Update title
  const titleElement = card.querySelector('.risk-card-title');
  if (titleElement) {
    titleElement.textContent = data.title;
  }
  
  // Update category
  const categoryElement = card.querySelector('.risk-category-badge');
  if (categoryElement) {
    categoryElement.textContent = data.category;
    categoryElement.className = `risk-category-badge ${getCategoryClass(data.category)}`;
  }
  
  // Update description
  const descriptionElement = card.querySelector('.risk-card-description');
  if (descriptionElement) {
    descriptionElement.textContent = data.description || 'No description available';
  }
  
  // Update likelihood
  const likelihoodElement = card.querySelector('.risk-metric-item:nth-child(1) .risk-metric-value');
  if (likelihoodElement) {
    likelihoodElement.textContent = data.likelihood || '-';
  }
  
  // Update impact
  const impactElement = card.querySelector('.risk-metric-item:nth-child(2) .risk-metric-value');
  if (impactElement) {
    impactElement.textContent = data.impact || '-';
  }
  
  // Update risk score
  const riskScoreElement = card.querySelector('.risk-score-badge');
  if (riskScoreElement && data.likelihood && data.impact) {
    const riskScore = data.likelihood * data.impact;
    riskScoreElement.textContent = riskScore;
    riskScoreElement.className = `risk-score-badge risk-score-${riskScore}`;
  }
}

// Exit edit mode
function exitEditMode(card, riskId) {
  // Remove editing class
  card.classList.remove('editing');
  
  // Show/hide appropriate buttons
  const editBtn = card.querySelector('.edit-risk-btn');
  const editActions = card.querySelector('.inline-edit-actions');
  
  if (editBtn) editBtn.style.display = 'inline-block';
  if (editActions) editActions.style.display = 'none';
  
  // Clean up stored values
  originalValues.delete(riskId);
}

// Mock Dataverse API call (replace with actual implementation)
async function saveToDataverse(riskId, data) {
  console.log('📡 Saving to Dataverse:', { riskId, data });
  
  // Simulate API delay
  await new Promise(resolve => setTimeout(resolve, 1000));
  
  // TODO: Replace with actual Dataverse REST API call
  /*
  const response = await fetch(`/_api/cr129_risk(${riskId})`, {
    method: 'PATCH',
    headers: {
      'Content-Type': 'application/json',
      'OData-MaxVersion': '4.0',
      'OData-Version': '4.0'
    },
    body: JSON.stringify({
      cr129_risktitle: data.title,
      cr129_riskcategory: data.category,
      cr129_description: data.description,
      cr129_inherentlikelihood: data.likelihood,
      cr129_inherentimpact: data.impact
    })
  });
  
  if (!response.ok) {
    throw new Error('Failed to save to Dataverse');
  }
  */
}

// Helper function to get category class
function getCategoryClass(category) {
  const categoryMap = {
    'Operational': 'operational',
    'Technology': 'technology',
    'Fraud': 'fraud',
    'Compliance': 'compliance',
    'Credit': 'credit',
    'Market': 'market',
    'Liquidity': 'liquidity',
    'Reputational': 'reputational'
  };
  return categoryMap[category] || 'default';
}

// Show success message
function showSuccessMessage(message) {
  if (typeof modernInteractions !== 'undefined') {
    modernInteractions.showSuccess('Success', message);
  } else {
    // Fallback toast
    showToast(message, 'success');
  }
}

// Show error message
function showErrorMessage(message) {
  if (typeof modernInteractions !== 'undefined') {
    modernInteractions.showError('Error', message);
  } else {
    // Fallback toast
    showToast(message, 'error');
  }
}

// Simple toast fallback
function showToast(message, type) {
  const toast = document.createElement('div');
  toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed`;
  toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
  toast.innerHTML = `
    <div class="d-flex align-items-center">
      <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
      ${message}
    </div>
  `;
  
  document.body.appendChild(toast);
  
  // Auto-remove after 3 seconds
  setTimeout(() => {
    toast.remove();
  }, 3000);
}

// Keyboard shortcuts for inline editing
document.addEventListener('keydown', function(event) {
  // Only handle shortcuts when editing
  if (!document.querySelector('.risk-card.editing')) return;
  
  if (event.key === 'Escape') {
    // Cancel all editing
    const editingCards = document.querySelectorAll('.risk-card.editing');
    editingCards.forEach(card => {
      const riskId = card.dataset.riskId;
      cancelInlineEdit(riskId);
    });
  }
  
  if (event.key === 'Enter' && (event.ctrlKey || event.metaKey)) {
    // Save current editing (Ctrl+Enter or Cmd+Enter)
    const editingCard = document.querySelector('.risk-card.editing');
    if (editingCard) {
      const riskId = editingCard.dataset.riskId;
      saveInlineEdit(riskId);
    }
  }
});

</script>

<style>
/* ============================================================================ */
/* INLINE EDITING STYLES */
/* ============================================================================ */

/* Editing state for risk cards */
.risk-card.editing {
  border: 2px solid #0d6efd;
  box-shadow: 0 8px 32px rgba(13, 110, 253, 0.15);
  background: linear-gradient(135deg, #ffffff 0%, #f8f9ff 100%);
}

/* Inline edit form controls */
.inline-edit-input,
.inline-edit-select,
.inline-edit-textarea {
  border: 1px solid #dee2e6;
  border-radius: 6px;
  font-size: 0.875rem;
  padding: 0.375rem 0.75rem;
  transition: all 0.2s ease;
}

.inline-edit-input:focus,
.inline-edit-select:focus,
.inline-edit-textarea:focus {
  border-color: #0d6efd;
  box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
  outline: 0;
}

/* Title input styling */
.risk-card-title .inline-edit-input {
  font-size: 1.1rem;
  font-weight: 600;
  border: 2px solid #0d6efd;
  background: rgba(13, 110, 253, 0.05);
}

/* Category select styling */
.risk-category-badge .inline-edit-select {
  font-size: 0.75rem;
  padding: 0.25rem 0.5rem;
  min-width: 120px;
  font-weight: 500;
}

/* Description textarea styling */
.risk-card-description .inline-edit-textarea {
  resize: vertical;
  min-height: 60px;
}

/* Metric select styling */
.risk-metric-value .inline-edit-select {
  font-size: 0.875rem;
  padding: 0.25rem 0.5rem;
  min-width: 60px;
  text-align: center;
  font-weight: 500;
}

/* Edit action buttons */
.inline-edit-actions {
  display: none;
  gap: 0.5rem;
  align-items: center;
}

.inline-edit-actions .btn {
  font-size: 0.75rem;
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  font-weight: 500;
}

.inline-edit-actions .btn-success {
  background: linear-gradient(135deg, #198754, #20c997);
  border: none;
}

.inline-edit-actions .btn-success:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(25, 135, 84, 0.3);
}

.inline-edit-actions .btn-secondary {
  background: #6c757d;
  border: none;
}

.inline-edit-actions .btn-secondary:hover {
  background: #5a6268;
  transform: translateY(-1px);
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .inline-edit-actions {
    flex-direction: column;
    width: 100%;
    gap: 0.25rem;
  }
  
  .inline-edit-actions .btn {
    width: 100%;
    font-size: 0.75rem;
  }
  
  .risk-card-title .inline-edit-input {
    font-size: 1rem;
  }
}

/* Smooth transitions */
.risk-card {
  transition: all 0.3s ease;
}

.risk-card-actions {
  transition: all 0.2s ease;
}

/* Focus ring for accessibility */
.inline-edit-input:focus,
.inline-edit-select:focus,
.inline-edit-textarea:focus {
  outline: 2px solid #0d6efd;
  outline-offset: 2px;
}

/* Loading state for save button */
.inline-edit-actions .btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

/* Validation states */
.inline-edit-input.is-invalid,
.inline-edit-select.is-invalid,
.inline-edit-textarea.is-invalid {
  border-color: #dc3545;
  background-color: rgba(220, 53, 69, 0.05);
}

.inline-edit-input.is-valid,
.inline-edit-select.is-valid,
.inline-edit-textarea.is-valid {
  border-color: #198754;
  background-color: rgba(25, 135, 84, 0.05);
}
</style>


